# 服务器文件浏览器与符号连接语义说明

本文档描述当前实现下，`/api/server-files/*`、发送文件到设备、发送脚本相关的实际语义，重点说明符号连接（symlink）的行为。

## 1. 适用范围

1. 服务器文件浏览器相关接口：
`/api/server-files/list|upload|create|rename|read|save|download|delete|batch-copy|batch-move`
2. 从服务器文件浏览器发送文件到设备：
`POST /api/transfer/push-to-device`（由前端递归收集文件后逐个调用）
3. 脚本列表与发送脚本：
`GET /api/scripts/selectable`、`POST /api/scripts/send`、`POST /api/scripts/send-and-start`

## 2. 术语

1. 文件符号连接：指向某个文件的 symlink。
2. 目录符号连接：指向某个目录的 symlink。
3. 深度遍历：递归遍历目录下所有子层级。

## 3. 文件浏览器行为矩阵（当前实现）

| 操作 | 文件符号连接 | 目录符号连接 |
|---|---|---|
| 列表显示 | 显示为 `type=file`，`isSymlink=true` | 显示为 `type=dir`，`isSymlink=true` |
| 读取/保存/下载 | 跟随到目标文件内容 | 不适用（目录不允许 read/download） |
| 删除 | 删除符号连接本体 | 删除符号连接本体（不会删除目标目录） |
| 复制（batch-copy） | 复制符号连接本体 | 复制符号连接本体 |
| 剪切（batch-move） | 移动符号连接本体 | 移动符号连接本体 |
| 重命名 | 重命名符号连接本体 | 重命名符号连接本体 |

说明：
1. 列表接口会返回 `isSymlink`，并使用跟随目标后的类型判定 `type=file|dir`。
2. `copy/move` 在同文件系统优先 `rename`，跨文件系统 fallback 为 `copy + delete`，两种路径都保持“符号连接本体语义”。
3. 删除目录符号连接时不会递归删除其目标内容。

## 4. 发送文件到设备语义（服务器文件浏览器）

前端在发送前会先递归收集要发送的文件列表，然后逐个调用 `push-to-device`。

### 4.1 选中“文件符号连接”

1. 前端按文件条目发送该路径。
2. 后端 `push-to-device` 使用 `os.Stat` / `os.ReadFile` 读取，行为为跟随符号连接到目标文件。
3. 实际发送到设备的是目标文件内容。

### 4.2 选中“目录符号连接”

1. 前端会进入该目录并做深度遍历（即遍历的是符号连接指向目录的内容）。
2. 深度遍历中若遇到“目录符号连接”，直接忽略，不继续深入。
3. 深度遍历中若遇到“文件符号连接”，按文件处理并发送目标文件内容。

### 4.3 选中“普通目录”

1. 同样执行深度遍历。
2. 规则与上面一致：
深度遇到目录符号连接忽略；深度遇到文件符号连接按目标文件内容发送。

## 5. 发送脚本语义

脚本发送打包阶段使用后端遍历逻辑，规则与文件发送保持一致：

1. 根目录可以是目录符号连接（会跟随到目标目录打包）。
2. 深度遍历中遇到目录符号连接：忽略，不深入。
3. 深度遍历中遇到文件符号连接：按文件处理，读取目标文件内容参与打包与发送。

## 6. 脚本列表可选项语义（`/api/scripts/selectable`）

1. `scripts/` 根目录条目会跟随符号连接目标判定“是否目录”。
2. 因此以下条目可被识别并显示为可选脚本：
目录符号连接 -> 平铺脚本目录（含 `lua/scripts/main.lua` 或 `main.xxt`）。
3. 对于扩展名为 `.xpp` 且指向目录的符号连接，也会显示为可选脚本。

## 7. 路径边界与安全说明

1. 原始路径输入仍有路径穿越校验（防 `..` 逃逸）。
2. 校验是“路径字符串级别”的边界约束，不阻止符号连接指向 `data` 目录外目标。
3. 因此，若在 `scripts/files/reports` 下放置指向外部路径的符号连接，读写/发送会按上述语义作用于其目标内容或目标目录（删除/复制/剪切符号连接本体除外）。

